---
title: "Tomcat源码分析（一）"
subtitle: "启动加载"
date: 2018-12-31
categories: [framework, tomcat]
tags: [Tomcat, source code]
---
Tomcat源码分析系列的第一篇，我们从万物起源——启动脚本开始，总结Tomcat在启动过程中是如何从启动脚本开始将其各个组件所依赖的Class和Resource加载到JVM中的。

#### 从Tomcat的启动脚本入手

我们实验环境通常启动Tomcat的方法就是通过启动脚本`startup.sh`，所以我们就从这个脚本入手。

``` shell

  # startup.sh

  # 省略。。。。

  PRG="$0"

  # 省略。。。。

  PRGDIR=`dirname "$PRG"`
  EXECUTABLE=catalina.sh

  # 省略。。。。

  exec "$PRGDIR"/"$EXECUTABLE" start "$@"

```

从`startup.sh`的内容来看，是调用了`catalina.sh`这个脚本（中间我省略了定位`catalina.sh`的位置的内容），并且将`start`作为第一个参数传递并将调用`startup.sh`的参数透传。

``` shell

  # catalina.sh

  # 省略。。。。

elif [ "$1" = "start" ] ; then

  # 省略。。。。

  shift

  # 省略。。。。

  if [ "$1" = "-security" ] ; then
    if [ $have_tty -eq 1 ]; then
      echo "Using Security Manager"
    fi
    shift
    eval \{ $_NOHUP "\"$_RUNJAVA\"" "\"$LOGGING_CONFIG\"" $LOGGING_MANAGER $JAVA_OPTS $CATALINA_OPTS \
      -D$ENDORSED_PROP="\"$JAVA_ENDORSED_DIRS\"" \
      -classpath "\"$CLASSPATH\"" \
      -Djava.security.manager \
      -Djava.security.policy=="\"$CATALINA_BASE/conf/catalina.policy\"" \
      -Dcatalina.base="\"$CATALINA_BASE\"" \
      -Dcatalina.home="\"$CATALINA_HOME\"" \
      -Djava.io.tmpdir="\"$CATALINA_TMPDIR\"" \
      org.apache.catalina.startup.Bootstrap "$@" start \
      2\>\&1 \& echo \$! \>\"$catalina_pid_file\" \; \} $catalina_out_command "&"

  else
    eval \{ $_NOHUP "\"$_RUNJAVA\"" "\"$LOGGING_CONFIG\"" $LOGGING_MANAGER $JAVA_OPTS $CATALINA_OPTS \
      -D$ENDORSED_PROP="\"$JAVA_ENDORSED_DIRS\"" \
      -classpath "\"$CLASSPATH\"" \
      -Dcatalina.base="\"$CATALINA_BASE\"" \
      -Dcatalina.home="\"$CATALINA_HOME\"" \
      -Djava.io.tmpdir="\"$CATALINA_TMPDIR\"" \
      org.apache.catalina.startup.Bootstrap "$@" start \
      2\>\&1 \& echo \$! \>\"$catalina_pid_file\" \; \} $catalina_out_command "&"

  fi

  echo "Tomcat started."

  # 省略。。。。

```

从`catalina.sh`脚本的内容可以看出，Tomcat最终是通过`java`命令，调用入口类`org.apache.catalina.startup.Bootstrap`的main方法启动的，并将执行`catalina.sh`脚本的剩余入参以及`start`字符串作为启动参数传入。

#### Tomcat类加载过程

#### 加载和启动
